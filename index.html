<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Testing Zen</title>
  
    <link rel="stylesheet" href="reveal/css/reveal.min.css">
    <link rel="stylesheet" href="reveal/lib/css/github.css">

    <link rel="stylesheet" href="slides-theme/style.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="reveal">
<div class="slides">

<section data-markdown data-state=front><script type="text/template">
  
  <img src=img/zen.png style='height:500px' />

  <h1>Testing Zen</h1>

</script></section>

<section data-markdown data-state=title><script type="text/template">
  # Testing == Koans

  - koans are quite painful
  - they tell you that you're stupid and don't understand things
  - doing it helps you be less stupid, and understand more
  - both can be violent
  - both zen and testing can get in the way
  - in both cases the goal is for them to fade away

</script></section>

<section data-markdown data-state=title><script type="text/template">

<blockquote class=poem>
Four friends planned 7 days of silence,
on the forth day one shouted
"fix the lamp"!
One of his friends said, "we are not to talk!",
the other "you two are stupid".
The final friend smugly remarked,
"I am the only one who remained silent".
</blockquote>

</script></section>

<section data-markdown data-state=word><script type="text/template">
# Painful lessons
</script></section>

<section data-markdown data-state=word><script type="text/template">
<blockquote class=poem>
The master asked "this code has a failing test".
The student "but master, this code has no tests!".
"Fix the failing test, or I'll not merge".
</blockquote>
</script></section>


<section data-markdown data-state=word><script type="text/template">
# Test 0
</script></section>

<section data-markdown data-state=word><script type="text/template">
# Do you have any units?
</script></section>


<section data-markdown><script type="text/template">
```javascript
function sprintf(str) {
  var params = [].slice.call(arguments,1)
  var types = {
    "%s": function(x) { return x + "" }
  }
  var matches = 0
  return str.replace(/(%[is])/g,function(match) {
    return types[match](params[matches++])
  })
}

it("formats correctly",function() {
  assert.equal("MU!",sprintf("%s","MU!"));
})
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Can it be this simple?
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Get real
</script></section>

<section data-markdown class=small-code data-state=word><script type="text/template">

```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;

    api.users.generateResetToken(email).then(function (token) {
        var siteLink = '<a href="' + config().url + '">' + config().url + '</a>',
            resetUrl = config().url.replace(/\/$/, '') +  '/ghost/reset/' + token + '/',
            resetLink = '<a href="' + resetUrl + '">' + resetUrl + '</a>',
            message = {
                to: email,
                subject: 'Reset Password',
                html: '<p><strong>Hello!</strong></p>' +
                      '<p>A request has been made to reset the password on the site ' + siteLink + '.</p>' +
                      '<p>Please follow the link below to reset your password:<br><br>' + resetLink + '</p>' +
                      '<p>Ghost</p>'
            };

        return mailer.send(message);
    }).then(function success() {
        var notification = {
            type: 'success',
            message: 'Check your email for further instructions',
            status: 'passive',
            id: 'successresetpw'
        };

        return api.notifications.add(notification).then(function () {
            res.json(200, {redirect: config.paths().webroot + '/ghost/signin/'});
        });

    }, function failure(error) {
        // TODO: This is kind of sketchy, depends on magic string error.message from Bookshelf.
        // TODO: It's debatable whether we want to just tell the user we sent the email in this case or not, we are giving away sensitive info here.
        if (error && error.message === 'EmptyResponse') {
            error.message = "Invalid email address";
        }

        res.json(401, {error: error.message});
    });
},
```

</script></section>

<section data-markdown data-state=word><script type="text/template">

```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;
  
    api.users.generateResetToken(email).then(function (token) {
        var siteLink = '<a href="' + config().url + '">' + config().url + '</a>',
            resetUrl = config().url.replace(/\/$/, '') +  '/ghost/reset/' + token + '/',
            resetLink = '<a href="' + resetUrl + '">' + resetUrl + '</a>',
            message = {
                to: email,
                subject: 'Reset Password',
                html: '<p><strong>Hello!</strong></p>' +
                      '<p>A request has been made to reset the password on the site ' + siteLink + '.</p>' +
                      '<p>Please follow the link below to reset your password:<br><br>' + resetLink + '</p>' +
                      '<p>Ghost</p>'
            };

        return mailer.send(message);
    }).then(function success() {
      // ...
    }, function failure(error) {
      // ...
    });
},
```

</script></section>

<section data-markdown data-state=word><script type="text/template">

```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;

    api.users.generateResetToken(email).then(function (token) {
      // ...
    }).then(function success() {
      // ...
    }, function failure(error) {
        // TODO: This is kind of sketchy, depends on magic string error.message from Bookshelf.
        // TODO: It's debatable whether we want to just tell the user we sent the email in this case or not, we are giving away sensitive info here.
        if (error && error.message === 'EmptyResponse') {
            error.message = "Invalid email address";
        }

        res.json(401, {error: error.message});
    });
},
```

</script></section>

<section data-markdown data-state=word><script type="text/template">

```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;

    api.users.generateResetToken(email).then(function (token) {
      // ...
    }).then(function success() {
        var notification = {
            type: 'success',
            message: 'Check your email for further instructions',
            status: 'passive',
            id: 'successresetpw'
        };

        return api.notifications.add(notification).then(function () {
            res.json(200, {redirect: config.paths().webroot + '/ghost/signin/'});
        });
    }, function failure(error) {
      // ...
    });
},
```

</script></section>

<section data-markdown data-state=word><script type="text/template">
  # If not, why?
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # JS is easy to test
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # If you let it be
</script></section>

<section data-markdown data-state=word><script type="text/template">
```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;
    api.users.generateResetToken(email).then(
      api._sendMessage.bind(null,config,email)
    ).then(
      api._notifySuccess(res,{
        type: 'success',
        message: 'Check your email for further instructions',
        status: 'passive',
        id: 'successresetpw'
      })
      , api._handleFailure
    );
},

```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # a) Visiblity
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Name and reveal
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Async makes processes clear
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # b) Partials
</script></section>

<section data-markdown data-state=word><script type="text/template">
  ## Partial

  - JS uses higher-order-functions
  - Functions that take or return functions
  - `x.bind()` creates a 'partially applied' version of `x`
  - First arg is JS's OO's fault

  ```javascript
  var helloName = sprintf.bind(null,"Hello %s")
  helloName("Sue") // "Hello Sue"
  ```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Why?
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Steps with dependencies
</script></section>

<section data-markdown data-state=word><script type="text/template">
```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;
    api.users.generateResetToken(email).then(function (token) {
      // ...
      message = {
          to: email,
      // ...
    }).then(function success() {

    // ...
```

```javascript
'generateResetToken': function (req, res) {
    var email = req.body.email;
    api.users.generateResetToken(email).then(
      api._sendMessage.bind(null,config,email)
    ).then(function success() {
```
```javascript
_sendMessage: function(config,email,token) {
  // ...
}
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Unit tests need units
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Units have one job
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Isolate
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # until it's 'too easy'
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Tests have taught us modular JS
</script></section>


<section data-markdown data-state=word><script type="text/template">
  # Just functional test!
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # No x 3
</script></section>


<section data-markdown data-state=word><script type="text/template">
  # Functional tests are limited
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Edge-cases
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Functional tests are slow
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Functional tests don't hurt
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # ?!
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Tests are design critique
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Untestable: non-modular by definition
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Reveals coupling
</script></section>

<section data-markdown data-state=word><script type="text/template">
```javascript
var defaultConfig =  require('../../../config');

describe("Mail", function () {

    beforeEach(function () {
        // Mock config and settings
        fakeConfig = _.extend({}, defaultConfig);

// ...

it('should setup SMTP transport on initialization', function (done) {
  fakeConfig[process.env.NODE_ENV].mail = SMTP;
  mailer.init().then(function () {
      mailer.should.have.property('transport');
      mailer.transport.transportType.should.eql('SMTP');
      mailer.transport.sendMail.should.be.a.function;
      done();
  }).then(null, done);
});
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
# Temporal coupling
</script></section>

<section data-markdown data-state=word><script type="text/template">
# Please don't use modules as mutable globals
</script></section>


<section data-markdown data-state=word><script type="text/template">
# Brutality
</script></section>


<section data-markdown data-state=title><script type="text/template">

<blockquote class=poem>
Desiring to show his wisdom,
the student said:
"The mind, Buddha and world are merely illusions.
There is no giving and nothing to be received."

The master sat and smoked,
and then struck the youth with his pipe. 
The youth was angry. The master asked:

"If the world is merely an illusion,
where does this anger come from?"
</blockquote>

</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Creative, destructive

</script></section>

<section data-markdown data-state=word><script type="text/template">
  ## Destructive mind

  - All code is broken, I just haven't found out how yet
  - I punish my code because I take the blame for it 
  - The errors will remain, so I must squeeze the places to hide

  <br />

  <p><cite>Learn C the Hard Way</cite>, Zed Shaw</p>

</script></section>


<section data-markdown data-state=word><script type="text/template">
  # False positives
</script></section>

<section data-markdown data-state=word><script type="text/template">
## Coincidence

```javascript
it("creates a user",function(done) {
  app.post("/users",validUserAttrs)
     .then(function() {
       assert.equal(1,User.count())
       done()
     },done)
})
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
## Still

```javascript
it("creates a user",function(done) {
  assert.change(function(check) {
    app.post("/users",validUserAttrs)
       .then(function() {
         check()
         done()
       },done)
  },function() { return User.count() })
})
```
</script></section>


<section data-markdown data-state=word><script type="text/template">
## Again

```javascript
it("creates a user",function(done) {
  assert.change(function(check) {
    app.post("/users",validUserAttrs)
       .then(function() {
         check()
         assert.equal(validUserAttrs.name,User.first().name)
         done()
       },done)
  },function() { return User.count() })
})
```
</script></section>


<section data-markdown data-state=word><script type="text/template">
## Confident?

```javascript
it("creates a user",function(done) {
  assert.change(function(check) {
    app.post("/users",validUserAttrs)
       .then(function() {
         check()
         assert.equal(validUserAttrs.name,User.first().name)
         done()
       },done)
   },function() { return User.count() },{by: 1})
})
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
## Edge-cases

- Numbers: 0, Infinity, negative, irrational/rational
- Collections: empty, one, many
- Strings: empty, whitespace

</script></section>

<section data-markdown data-state=word><script type="text/template">

## Endless Koan of JS

```javascript
var string = "   \t\t\t\t \n \n \t \t\t\t"
while(string == false)
  string += ["\t","\n"," "][Math.random() * 3 | 0]
```

</script></section>



<section data-markdown data-state=word><script type="text/template">
## Table-driven tests

```javascript
var possibleGitObjectNames = [
  { name: "aeff938482", expected: git.SHA },
  { name: "master", expected: git.REF },
]

possibleGitObjectNames.forEach(function(setup) {
  it(util.format("correctly identifies '%s' as a '%s'",setup.name,setup.expected),function() {
    assert.equal(setup.expect,git.identifyObjectNameType(setup.name))
  })
})

var invalidObjectNames = [
  "../",
  "refs/heads/master",
  "\t"
]

invalidObjectNames.forEach(function(name) {
  it(util.format("identifies '%s' as an invalid object name",name),function() {
    assert.throws(function() {
      git.identifyObjectNameType(name)
    })
  })
})
```

</script></section>


<section data-markdown data-state=word><script type="text/template">
```javascript
function Untestable() {
  // 'private final'...
  function privateFn() {
  }
}

function Testable() {
}
Testable.prototype["-privateFn"] = function() {}
```
</script></section>



<section data-markdown data-state=word><script type="text/template">
  # Java's problems
</script></section>

<section data-markdown data-state=word><script type="text/template">
```javascript
function Untestable() {
  // 'private final'...
  function privateFn() {
  }
}

function Testable() {
}
Testable.prototype["-privateFn"] = function() {}
```
</script></section>


<section data-markdown data-state=word><script type="text/template">
  # OOP's problems
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Coupling
</script></section>

<section data-markdown data-state=word><script type="text/template">
  ## Test setup reveals coupling
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # No function units
</script></section>

<section data-markdown data-state=word><script type="text/template">
  ## Temporal coupling
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Mocks/stubs
</script></section>

<section data-markdown data-state=word><script type="text/template">
  ## Different reasons to be fake
</script></section>

<section data-markdown><script type="text/template">
## Stubs

- There to support a unit test
- Are not assertions
- Why would we use one?
- Mostly: because we don't have units!

```javascript
var controller = {
  handleSignin: function (req,res,err,user) {
    var header = req.get("X-Auth-Header")
    // continue...
  }
}
```
```javascript
var fake
beforeEach(function() {
  fake = {get: function() { return "555444" }}
})
it("signs in user",function() {
  controller.handleSignin(fake,{},null,user)
})
```
</script></section>

<section data-markdown><script type="text/template">
## Destub

- Separate arrangement from work

```javascript
var controller = {
  handleSigin: function(req,res,err,user) {
    if(err) return res.send(403)
    if(controller._validateSignin(req.get("X-Auth-Header"),user)) {
      // signin
    } else {
      // show error
    }
  },
  _validateSignin: function (authCode,user) {
    // flat, pure, synchronous work
    // ...
    return isValid
  }
}
```
```javascript
it("validates user presents correct authorisation code",function() {
  controller._validateSignin(correct,user)
})
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # Listen
</script></section>

<section data-markdown data-state=word><script type="text/template">
# Fluent...?
</script></section>

<section data-markdown data-state=word><script type="text/template">
## More stubs?

```javascript
var buttons = d3.select(el)
  .selectAll(".button")
  .data(response.map(function(data) {
    data.text = data.some_horrible_key
    return data
  })
  .text(function(d) { return d.text })
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
## More functions

```javascript
var buttons = updateButtons(el,formatResponse(response))

function updateButtons(el,data) {
  d3.select(el
}
```
</script></section>

<section data-markdown data-state=word><script type="text/template">
  ![ying yang](img/yingyang.png)
</script></section>

<section data-markdown data-state=word><script type="text/template">
  # If you let it be
</script></section>



<section data-markdown><script type="text/template">

# Any other questions?

## @timruffles, @sidekicksrc

</script></section>


</div>
</div>

<!-- library being demoed -->
<script src="../libs/underscore.js"></script>
<script src="../libs/backbone.js"></script>

<!-- reveal -->
<script src="reveal/lib/js/head.min.js"></script>
<script src="reveal/js/reveal.min.js"></script>
<script>
  Reveal.initialize({

    // Display controls in the bottom right corner
    controls: false,

    // Display a presentation progress bar
    progress: true,

    // Push each slide change to the browser history
    history: true,

    // Enable keyboard shortcuts for navigation
    keyboard: true,

    // Enable the slide overview mode
    overview: true,

    // Vertical centering of slides
    center: false,

    // Loop the presentation
    loop: false,

    // Change the presentation direction to be RTL
    rtl: false,

    // Number of milliseconds between automatically proceeding to the
    // next slide, disabled when set to 0, this value can be overwritten
    // by using a data-autoslide attribute on your slides
    autoSlide: 0,

    // Enable slide navigation via mouse wheel
    mouseWheel: false,

    // Apply a 3D roll to links on hover
    rollingLinks: false,

    // Transition style
    transition: 'linear', // default/cube/page/concave/zoom/linear/fade/none

    dependencies: [
        // Cross-browser shim that fully implements classList - https://github.com/eligrey/classList.js/
        { src: 'reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },

        // Interreveal/pret Markdown in <section> elements
         { src: 'reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },

        // Syntareveal/x highlight for <code> elements
        { src: 'reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },

        // Zoom reveal/in and out with Alt+click
        { src: 'reveal/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },

        // Speakreveal/er notes
        { src: 'reveal/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },

        // Remotreveal/e control your reveal.js presentation using a touch device
        // { src: 'reveal/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
    ]

  });
</script>
</body>

